<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="csrf-token" content="test-token" />
		<title>Test WhatsApp Buttons</title>
		<link
			rel="stylesheet"
			href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
		/>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	</head>
	<body class="p-5">
		<div class="container">
			<h1>üß™ Test de Botones WhatsApp</h1>
			<p class="text-muted">
				Esta p√°gina sirve para probar que el JavaScript funcione correctamente
			</p>

			<div class="alert alert-info">
				<strong>Instrucciones:</strong>
				<ol>
					<li>Abre la consola del navegador (F12)</li>
					<li>Ingresa un n√∫mero de tel√©fono</li>
					<li>Haz click en el bot√≥n de WhatsApp</li>
					<li>Observa los logs en la consola</li>
				</ol>
			</div>

			<!-- Test 1: Bot√≥n del Modal -->
			<div class="card mb-4">
				<div class="card-header bg-primary text-white">
					<h5><i class="fa fa-comment"></i> Test 1: Bot√≥n del Modal</h5>
				</div>
				<div class="card-body">
					<div class="form-group">
						<label for="whatsapp_phone">N√∫mero de tel√©fono (Modal)</label>
						<input
							type="tel"
							class="form-control"
							id="whatsapp_phone"
							placeholder="Ej: 59176543210"
							value="59176543210"
						/>
					</div>
					<button type="button" class="btn btn-success" id="send-whatsapp-btn">
						<i class="fa fa-whatsapp"></i> Enviar Factura (Modal)
					</button>
					<div class="mt-3">
						<small class="text-muted"
							>Sale ID simulado: <strong id="modal-sale-id">123</strong></small
						>
					</div>
				</div>
			</div>

			<!-- Test 2: Bot√≥n del Panel Final -->
			<div class="card mb-4">
				<div class="card-header bg-success text-white">
					<h5><i class="fa fa-check"></i> Test 2: Bot√≥n del Panel Final</h5>
				</div>
				<div class="card-body">
					<div class="form-group">
						<label for="final_whatsapp_phone">N√∫mero de tel√©fono (Final)</label>
						<input
							type="tel"
							class="form-control"
							id="final_whatsapp_phone"
							placeholder="Ej: 59176543210"
							value="59176543210"
						/>
					</div>
					<input type="hidden" name="ajax_sale_id" value="456" />
					<button
						type="button"
						class="btn btn-success"
						id="send-final-whatsapp-btn"
					>
						<i class="fa fa-whatsapp"></i> Enviar Factura (Final)
					</button>
					<div class="mt-3">
						<small class="text-muted"
							>Sale ID simulado: <strong>456</strong></small
						>
					</div>
				</div>
			</div>

			<!-- Logs -->
			<div class="card">
				<div class="card-header bg-dark text-white">
					<h5><i class="fa fa-list"></i> Logs de Eventos</h5>
				</div>
				<div class="card-body">
					<pre
						id="log-output"
						class="bg-light p-3"
						style="max-height: 300px; overflow-y: auto"
					></pre>
				</div>
			</div>
		</div>

		<!-- Modal simulado -->
		<div id="imprimir-factura-modal" data-sale-id="123"></div>

		<script>
			// Helper para mostrar logs en la p√°gina
			function addLog(message, type = "info") {
				const timestamp = new Date().toLocaleTimeString();
				const color =
					{
						info: "text-primary",
						success: "text-success",
						error: "text-danger",
						warning: "text-warning",
					}[type] || "text-dark";

				const logEl = document.getElementById("log-output");
				logEl.innerHTML =
					`[${timestamp}] <span class="${color}">${message}</span>\n` +
					logEl.innerHTML;
				console.log(`[${timestamp}] ${message}`);
			}

			// Verificar jQuery
			if (typeof $ === "undefined") {
				addLog("‚ùå ERROR: jQuery no est√° cargado", "error");
			} else {
				addLog("‚úÖ jQuery cargado correctamente: v" + $.fn.jquery, "success");
			}

			// Verificar SweetAlert2
			if (typeof Swal === "undefined") {
				addLog("‚ùå ERROR: SweetAlert2 no est√° cargado", "error");
			} else {
				addLog("‚úÖ SweetAlert2 cargado correctamente", "success");
			}

			$(document).ready(function () {
				addLog("‚úÖ Document Ready ejecutado", "success");

				// Verificar que los elementos existen
				addLog("üîç Verificando elementos del DOM...", "info");
				addLog(
					`  - #send-whatsapp-btn: ${$("#send-whatsapp-btn").length} elementos`,
					"info",
				);
				addLog(
					`  - #send-final-whatsapp-btn: ${$("#send-final-whatsapp-btn").length} elementos`,
					"info",
				);
				addLog(
					`  - #whatsapp_phone: ${$("#whatsapp_phone").length} elementos`,
					"info",
				);
				addLog(
					`  - #final_whatsapp_phone: ${$("#final_whatsapp_phone").length} elementos`,
					"info",
				);

				// ========== C√ìDIGO EXACTO DEL POS ==========

				// Enviar factura por WhatsApp desde el modal
				$(document).on("click", "#send-whatsapp-btn", function (event) {
					event.preventDefault();
					addLog("üî• CLICK DETECTADO en #send-whatsapp-btn", "warning");

					var phone = $("#whatsapp_phone").val().trim();
					var sale_id = $("#modal-sale-id").text(); // Simulado

					addLog(
						"üîç Click en bot√≥n WhatsApp (Modal): phone=" +
							phone +
							", sale_id=" +
							sale_id,
						"info",
					);

					console.log("üîç Click en bot√≥n WhatsApp (Modal)", {
						phone: phone,
						sale_id: sale_id,
						modal_data: $("#imprimir-factura-modal").data(),
					});

					if (!phone) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Tel√©fono vac√≠o", "warning");
						Swal.fire({
							icon: "warning",
							title: "N√∫mero requerido",
							text: "Por favor ingrese un n√∫mero de tel√©fono",
						});
						return;
					}

					// Validar formato b√°sico (solo n√∫meros)
					if (!/^[0-9]+$/.test(phone)) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Formato inv√°lido", "warning");
						Swal.fire({
							icon: "warning",
							title: "Formato inv√°lido",
							text: "Ingrese solo n√∫meros, sin espacios ni caracteres especiales",
						});
						return;
					}

					if (!sale_id) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Sale ID vac√≠o", "warning");
						Swal.fire({
							icon: "error",
							title: "Error",
							text: "No se pudo identificar la factura",
						});
						return;
					}

					addLog("‚úÖ Todas las validaciones pasaron", "success");

					// Deshabilitar bot√≥n mientras se env√≠a
					var $btn = $(this);
					var originalText = $btn.html();
					$btn
						.prop("disabled", true)
						.html('<i class="fa fa-spinner fa-spin"></i> Enviando...');
					addLog("üîÑ Bot√≥n deshabilitado, iniciando AJAX...", "info");

					console.log("üì§ Enviando factura por WhatsApp (Modal)", {
						sale_id: sale_id,
						phone: phone,
						url: "/sales/send-invoice-whatsapp",
					});

					// Simulaci√≥n de AJAX (cambiar por AJAX real en producci√≥n)
					setTimeout(function () {
						addLog("‚úÖ Simulaci√≥n: Factura enviada exitosamente", "success");
						$btn.prop("disabled", false).html(originalText);
						Swal.fire({
							icon: "success",
							title: "¬°Enviado!",
							text: "‚úÖ Factura enviada exitosamente por WhatsApp (SIMULADO)",
							timer: 3000,
						});
					}, 1000);

					/* AJAX REAL (descomentar en producci√≥n)
                $.ajax({
                    url: '/sales/send-invoice-whatsapp',
                    type: 'POST',
                    data: {
                        _token: $('meta[name="csrf-token"]').attr('content'),
                        sale_id: sale_id,
                        phone: phone
                    },
                    success: function(response) {
                        addLog('‚úÖ Respuesta del servidor: ' + JSON.stringify(response), 'success');
                        console.log('‚úÖ Respuesta del servidor:', response);
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¬°Enviado!',
                                text: response.message,
                                timer: 3000
                            });
                            $('#whatsapp_phone').val('');
                        } else {
                            console.error('Error en respuesta:', response);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'No se pudo enviar la factura'
                            });
                        }
                    },
                    error: function(xhr) {
                        addLog('‚ùå Error AJAX: ' + JSON.stringify(xhr.responseJSON), 'error');
                        console.error('Error AJAX:', xhr);
                        var errorMsg = 'Error al enviar la factura por WhatsApp';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMsg
                        });
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
                */
				});

				// Enviar factura por WhatsApp desde el panel final
				$(document).on("click", "#send-final-whatsapp-btn", function (event) {
					event.preventDefault();
					addLog("üî• CLICK DETECTADO en #send-final-whatsapp-btn", "warning");

					var phone = $("#final_whatsapp_phone").val().trim();
					var sale_id = $('input[name="ajax_sale_id"]').val();

					addLog(
						"üîç Click en bot√≥n WhatsApp (Final Tab): phone=" +
							phone +
							", sale_id=" +
							sale_id,
						"info",
					);

					console.log("üîç Click en bot√≥n WhatsApp (Final Tab)", {
						phone: phone,
						sale_id: sale_id,
						ajax_sale_id_value: $('input[name="ajax_sale_id"]').val(),
						ajax_sale_id_element: $('input[name="ajax_sale_id"]'),
					});

					if (!phone) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Tel√©fono vac√≠o", "warning");
						Swal.fire({
							icon: "warning",
							title: "N√∫mero requerido",
							text: "Por favor ingrese un n√∫mero de tel√©fono",
						});
						return;
					}

					if (!/^[0-9]+$/.test(phone)) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Formato inv√°lido", "warning");
						Swal.fire({
							icon: "warning",
							title: "Formato inv√°lido",
							text: "Ingrese solo n√∫meros, sin espacios ni caracteres especiales",
						});
						return;
					}

					if (!sale_id) {
						addLog("‚ö†Ô∏è Validaci√≥n fallida: Sale ID vac√≠o", "warning");
						Swal.fire({
							icon: "error",
							title: "Error",
							text: "No se pudo identificar la venta",
						});
						return;
					}

					addLog("‚úÖ Todas las validaciones pasaron", "success");

					var $btn = $(this);
					var originalText = $btn.html();
					$btn
						.prop("disabled", true)
						.html('<i class="fa fa-spinner fa-spin"></i> Enviando...');
					addLog("üîÑ Bot√≥n deshabilitado, iniciando AJAX...", "info");

					// Simulaci√≥n
					setTimeout(function () {
						addLog("‚úÖ Simulaci√≥n: Factura enviada exitosamente", "success");
						$btn.prop("disabled", false).html(originalText);
						Swal.fire({
							icon: "success",
							title: "¬°Enviado!",
							text: "‚úÖ Factura enviada exitosamente por WhatsApp (SIMULADO)",
							timer: 3000,
						});
					}, 1000);
				});

				addLog("‚úÖ Event listeners registrados correctamente", "success");
			});
		</script>
	</body>
</html>
